# Техническое задание v.4.0
## Сервис аутентификации (Authentication Service)

> Актуализация (по итогам `TZ_GAP_ANALYSIS`):
> - Контракты `/auth/restore`, `/auth/reset-confirm`, `/api/tenants/{tenant_id}/invites`, `/api/invites/accept`, `/auth/logout`, `/auth/sessions`, `/auth/sessions/{family_id}/trust` синхронизированы с приоритетными требованиями GAP-анализа.
> - Для `/auth/restore`, `/auth/reset-confirm`, `/api/tenants/{tenant_id}/invites` обязателен `Idempotency-Key`.
> - `/auth/restore` всегда возвращает `202 Accepted` без выдачи reset-токена в ответе.
> - `/auth/reset-confirm` возвращает `200 OK` и JSON `{ "success": true }`.
> - `/auth/logout` принимает `refresh_token` (опционально) вместо `family_id`.
> - `GET /auth/sessions` возвращает расширенную информацию по устройствам; `PATCH /auth/sessions/{family_id}/trust` реально обновляет флаг доверия.
> - JWT claims используют `tid` и `fam`.

## Оглавление
1. [Термины и определения](#1-термины-и-определения)
2. [Архитектура сервиса](#2-архитектура-сервиса)
3. [Архитектура базы данных](#3-архитектура-базы-данных-postgresql)
4. [Механизмы безопасности](#4-механизмы-безопасности)
5. [Бизнес-логика приглашений](#5-бизнес-логика-приглашений-invites)
6. [Мультиустройственная аутентификация](#6-мультиустройственная-аутентификация-multidevice)
7. [API Контракты](#7-api-контракты)
8. [Спецификация JWT](#8-спецификация-jwt)
9. [Инфраструктурные требования](#9-инфраструктурные-требования)
10. [Нефункциональные требования](#10-нефункциональные-требования)
11. [Наблюдаемость](#11-наблюдаемость)
12. [Рекомендации по технологическому стеку](#12-Рекомендации-по-технологическому-стеку)
13. [Заключение](#13-заключение)

---

## 1. Термины и определения

| Термин | Определение |
|--------|-------------|
| **Identity (Идентификатор)** | Сущность, по которой пользователь узнается системой (email, phone, login). Один пользователь может иметь несколько Identities |
| **Tenant (Арендатор)** | Изолированная область данных. Пользователь в Tenant A и пользователь в Tenant B — разные сущности с точки зрения прав доступа |
| **Token Family** | Группа токенов, порожденных одной авторизацией (одной сессией на конкретном устройстве) |
| **JTI (JWT ID)** | Уникальный идентификатор конкретного токена для защиты от повторного использования |
| **ISS (Issuer)** | Поле в JWT, идентифицирующее сервис, выпустивший токен |
| **Token Rotation** | Механизм, при котором каждый Refresh приводит к выдаче новой пары токенов и инвалидации старой |
| **Reuse Detection** | Алгоритм обнаружения использования уже "сожженного" Refresh-токена |
| **Idempotency Key** | Уникальный ключ для обеспечения идемпотентности запросов |
| **Soft Delete** | Механизм пометки записи как удаленной без физического удаления из БД |
| **Key Rotation** | Процесс регулярной смены ключей подписи JWT |
| **CQRS** | Разделение операций чтения и записи на разные модели данных |

---

## 2. Архитектура сервиса

### 2.1. Принципы построения

Сервис строится на следующих архитектурных принципах:

1. **Чистая архитектура (Clean Architecture)**:
   - **Domain Layer** — бизнес-правила и сущности (не зависят от внешнего мира)
   - **Application Layer** — use cases, координация операций
   - **Infrastructure Layer** — работа с БД, Redis, email, внешние сервисы
   - **API Layer** — обработка HTTP-запросов, валидация

2. **Разделение ответственности**:
   - Read и Write операции могут масштабироваться независимо
   - Кэширующие слои для read-операций

3. **Graceful Degradation**:
   - При падении Redis сервис продолжает работу с ограниченной функциональностью
   - In-memory кэш для критических проверок

### 2.2. Слои сервиса

#### Domain Layer (ядро)
Содержит чистую бизнес-логику:
- Модели пользователей, тенантов, сессий
- Правила валидации паролей
- Алгоритмы token rotation
- Бизнес-правила приглашений

*Не имеет зависимостей от инфраструктуры, БД или HTTP*

#### Application Layer (сценарии использования)
Координирует выполнение бизнес-операций:
- Регистрация пользователя
- Аутентификация
- Управление сессиями
- Приглашения

#### Infrastructure Layer (адаптеры)
Реализует интерфейсы для работы с внешними системами:
- PostgreSQL (основное хранилище)
- Redis (кэш, blacklist)
- Email-сервис (уведомления)
- Push-сервис (уведомления на устройства)

#### API Layer (представление)
Обрабатывает HTTP-запросы:
- Валидация входных данных
- Формирование ответов
- Middleware (аутентификация, логирование)

### 2.3. Модель данных с типизированными идентификаторами

Все идентификаторы строго типизированы для предотвращения случайного смешения:

| Тип ID | Назначение |
|--------|------------|
| `UserId` | Идентификатор пользователя |
| `TenantId` | Идентификатор тенанта |
| `FamilyId` | Идентификатор сессии/устройства |
| `InviteId` | Идентификатор приглашения |

---

## 3. Архитектура базы данных (PostgreSQL)

### 3.1. Общие принципы

- **Мягкое удаление**: все таблицы с пользовательскими данными содержат `deleted_at`
- **Уникальность с учетом soft delete**: частичные индексы `WHERE deleted_at IS NULL`
- **Версионирование схемы**: миграции через последовательные изменения
- **Read-модели**: отдельные таблицы/представления для чтения при необходимости

### 3.2. Таблица tenants

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | UUID (PK) | Уникальный идентификатор арендатора |
| slug | TEXT UNIQUE NOT NULL | Уникальный идентификатор для URL |
| name | TEXT NOT NULL | Название организации |
| settings | JSONB | Настройки (пароли, токены, лимиты устройств) |
| key_version | INTEGER DEFAULT 1 | Текущая версия ключа подписи |
| deleted_at | TIMESTAMPZ | NULL если активен |
| created_at | TIMESTAMPZ DEFAULT now() | Дата создания |

### 3.3. Таблица users

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | UUID (PK) | Уникальный идентификатор |
| status | TEXT | active, blocked, pending, deleted |
| created_at | TIMESTAMPZ | Дата создания |
| updated_at | TIMESTAMPZ | Дата обновления |
| deleted_at | TIMESTAMPZ | Дата мягкого удаления |
| anonymized_at | TIMESTAMPZ | Дата анонимизации (GDPR) |

### 3.4. Таблица identities

| Колонка | Тип | Описание |
|---------|-----|----------|
| id | UUID (PK) | Уникальный идентификатор |
| user_id | UUID | Ссылка на users.id |
| type | TEXT | email, phone, login, sso_provider |
| value | TEXT | Значение идентификатора |
| is_verified | BOOLEAN | Подтвержден ли |
| deleted_at | TIMESTAMPZ | Дата мягкого удаления |
| created_at | TIMESTAMPZ | Дата создания |

**Ограничения**: UNIQUE (type, value) WHERE deleted_at IS NULL

### 3.5. Таблица credentials

| Колонка | Тип | Описание |
|---------|-----|----------|
| user_id | UUID (PK) | Ссылка на users.id |
| password_hash | TEXT | Хеш пароля (Argon2id) |
| updated_at | TIMESTAMPZ | Дата последнего обновления |

### 3.6. Таблица tenant_members

Связь пользователей с тенантами (M:M).

| Колонка | Тип | Описание |
|---------|-----|----------|
| user_id | UUID | Ссылка на пользователя |
| tenant_id | UUID | Ссылка на тенант |
| status | TEXT | invited, active, suspended |
| joined_at | TIMESTAMPZ | Дата принятия приглашения |
| invited_by | UUID | Кто пригласил |
| invited_at | TIMESTAMPZ | Дата создания приглашения |
| deleted_at | TIMESTAMPZ | Дата исключения |

**Первичный ключ**: (user_id, tenant_id)

### 3.7. Таблица refresh_sessions

| Колонка | Тип | Описание |
|---------|-----|----------|
| family_id | UUID (PK) | ID сессии (устройства) |
| current_jti | TEXT | Хеш текущего Refresh-токена |
| user_id | UUID | Ссылка на пользователя |
| tenant_id | UUID | Тенант сессии |
| device_info | JSONB | brand, model, os_version |
| device_name | TEXT | Пользовательское имя устройства |
| device_type | TEXT | mobile, tablet, desktop, browser, api |
| user_agent | TEXT | User-Agent |
| ip_address | INET | IP адрес |
| created_at | TIMESTAMPZ | Дата создания |
| last_rotated_at | TIMESTAMPZ | Последняя ротация |
| last_active_at | TIMESTAMPZ | Последняя активность |
| is_current | BOOLEAN | Текущее устройство |
| is_trusted | BOOLEAN | Доверенное устройство |
| deleted_at | TIMESTAMPZ | Дата инвалидации |

**Индексы**:
- UNIQUE WHERE deleted_at IS NULL (current_jti)
- (user_id) WHERE deleted_at IS NULL
- (user_id, device_type)
- (last_active_at DESC)

### 3.8. Таблица device_push_tokens

| Колонка | Тип | Описание |
|---------|-----|----------|
| user_id | UUID | Ссылка на пользователя |
| family_id | UUID | Ссылка на сессию |
| push_token | TEXT | Токен для push |
| platform | TEXT | apns, fcm, webpush |
| app_version | TEXT | Версия приложения |
| created_at | TIMESTAMPZ | Дата регистрации |
| updated_at | TIMESTAMPZ | Дата обновления |

**Первичный ключ**: (user_id, family_id)

### 3.9. Таблица idempotency_keys

| Колонка | Тип | Описание |
|---------|-----|----------|
| idempotency_key | TEXT | Ключ от клиента |
| endpoint | TEXT | Эндпоинт |
| user_id | UUID | ID пользователя (если известен) |
| request_hash | TEXT | Хеш тела запроса |
| response_code | INTEGER | HTTP-код ответа |
| response_body | JSONB | Тело ответа |
| created_at | TIMESTAMPZ | Дата создания |
| expires_at | TIMESTAMPZ | Время истечения |

**Первичный ключ**: (idempotency_key, endpoint)

### 3.10. Таблица password_resets

| Колонка | Тип | Описание |
|---------|-----|----------|
| token_hash | TEXT (PK) | Хеш токена сброса |
| user_id | UUID | Ссылка на пользователя |
| used_at | TIMESTAMPZ | NULL если не использован |
| expires_at | TIMESTAMPZ | Время истечения |
| created_at | TIMESTAMPZ | Дата создания |

### 3.11. Таблица pending_invites

| Колонка | Тип | Описание |
|---------|-----|----------|
| token_hash | TEXT (PK) | Хеш токена приглашения |
| user_id | UUID | Ссылка на пользователя |
| tenant_id | UUID | Тенант назначения |
| invited_by | UUID | Кто пригласил |
| used_at | TIMESTAMPZ | NULL если не использован |
| expires_at | TIMESTAMPZ | Время истечения |
| created_at | TIMESTAMPZ | Дата создания |

### 3.12. Таблица key_store (новая)

Хранение истории ключей подписи JWT.

| Колонка | Тип | Описание |
|---------|-----|----------|
| kid | TEXT (PK) | ID ключа |
| tenant_id | UUID | Тенант (NULL для глобальных) |
| public_key | TEXT | Публичный ключ в PEM |
| private_key_encrypted | TEXT | Зашифрованный приватный ключ |
| created_at | TIMESTAMPZ | Дата создания |
| expires_at | TIMESTAMPZ | Дата истечения (ротация) |
| revoked_at | TIMESTAMPZ | Дата отзыва |

---

## 4. Механизмы безопасности

### 4.1. Token Rotation & Reuse Detection

**Алгоритм работы**:
1. Каждый Refresh-токен имеет уникальный JTI (хранится в виде SHA-256 хеша)
2. При успешном refresh:
   - Генерируется новый JTI
   - Обновляется поле `current_jti` в сессии
   - Старый токен становится невалидным

3. **Обнаружение атаки**:
   - Если предоставлен JTI, не совпадающий с `current_jti`, но принадлежащий этой семье:
   - Вся семья (все записи с этим `family_id`) инвалидируется
   - Оба участника (легитимный и злоумышленник) разлогиниваются
   - Создается событие безопасности

### 4.2. Blacklist с graceful degradation

**Двухуровневая система**:
1. **Основной уровень (Redis)**:
   - Хранение blacklist с TTL
   - Быстрые операции проверки

2. **Fallback-уровень (in-memory)**:
   - Локальный кэш последних N отозванных токенов
   - Активируется при недоступности Redis
   - Ограниченный размер, автоматическое вытеснение

**Поведение при отказе Redis**:
- Сервис продолжает работу
- Проверка blacklist выполняется по in-memory кэшу
- Логируется недоступность Redis
- Операции записи в blacklist буферизируются

### 4.3. Key Rotation (ротация ключей)

**Механизм ротации**:
1. Ключи подписи JWT имеют версионность
2. Регулярная автоматическая ротация (настраиваемый период)
3. Старые ключи хранятся для валидации существующих токенов
4. Grace period для перехода на новые ключи

**Процесс ротации**:
- Генерация новой пары ключей с новым `kid`
- Добавление в JWKS endpoint
- Старые ключи помечаются как истекающие
- После grace period старые ключи удаляются

### 4.4. Session Invalidation

**Триггеры инвалидации**:
- Явный logout
- Изменение статуса в тенанте
- Достижение лимита устройств
- Подозрение на компрометацию
- Административное действие

**Процесс**:
1. Найти все активные сессии (refresh_sessions)
2. Добавить все JTI соответствующих Access Token'ов в blacklist
3. Пометить сессии как удаленные (`deleted_at = now()`)
4. Отправить push-уведомления на устройства (опционально)

### 4.5. Idempotency (Идемпотентность)

**Где применяется**:
- `/auth/restore` — восстановление пароля
- `/auth/reset-confirm` — подтверждение сброса
- `/api/tenants/{tenant_id}/invites` — создание приглашений
- Другие мутационные операции

**Механизм работы**:
1. Клиент передает `Idempotency-Key` в заголовке
2. Сервис проверяет наличие ключа:
   - Не найден: выполняется операция, результат сохраняется
   - Найден и request_hash совпадает: возвращается сохраненный ответ
   - Найден, но хеш не совпадает: ошибка 422
3. Хранение с TTL (24 часа), автоматическая очистка

### 4.6. Хеширование sensitive данных

| Данные | Алгоритм | Примечание |
|--------|----------|------------|
| Пароли | Argon2id | Соль для каждого пароля, настраиваемая сложность |
| Refresh-токены | SHA-256 | Хранятся только хеши |
| Токены сброса | SHA-256 | Одноразовые, с TTL |
| Токены приглашений | SHA-256 | Одноразовые, с TTL |

### 4.7. Компартментализация данных (новая)

**Принцип изоляции**:
- Данные разных тенантов физически разделены в БД
- Запросы всегда содержат контекст тенанта
- Невозможность случайного доступа к данным другого тенанта

---

## 5. Бизнес-логика приглашений (Invites)

### 5.1. Модель данных

Связь пользователей с тенантами через `tenant_members` со статусами:
- `invited` — приглашение отправлено, не принято
- `active` — активный участник
- `suspended` — заблокирован/исключен

### 5.2. Сценарий А: Приглашение существующего пользователя

1. **Запрос**: Администратор передает email
2. **Поиск**: Система находит `identity` по email, получает `user_id`
3. **Действие**: Создание записи в `tenant_members` со статусом `invited`
4. **Уведомление**: Письмо "Вас пригласили в организацию Х"
5. **Акцепт**: Пользователь подтверждает (будучи залогиненным) → статус `active`

### 5.3. Сценарий Б: Приглашение внешнего пользователя

1. **Запрос**: Администратор передает email
2. **Поиск**: Email не найден
3. **Транзакция**:
   - Создание пользователя (`users` со статусом `pending`)
   - Создание identity (`is_verified = false`)
   - Создание `tenant_members` со статусом `invited`
4. **Уведомление**: Письмо со ссылкой на регистрацию
5. **Онбординг**:
   - Переход по ссылке
   - Установка пароля
   - `identity.is_verified → true`
   - `tenant_members.status → active`

### 5.4. Сценарий В: Принятие приглашения

**Для существующего пользователя**:
1. Переход по ссылке с токеном
2. `POST /api/invites/accept` с токеном
3. Обновление `tenant_members` → статус `active`, `joined_at = now()`
4. Токен помечается использованным

**Для нового пользователя**:
1. Переход по ссылке
2. Система определяет отсутствие credentials
3. Редирект на страницу установки пароля
4. После установки — активация членства

### 5.5. Сценарий Г: Отзыв или исключение

**Revoke Invite** (до принятия):
- `DELETE /api/tenants/{tenant_id}/invites/{invite_id}`
- Мягкое удаление записи

**Kick Member** (после принятия):
- `DELETE /api/tenants/{tenant_id}/members/{user_id}`
- Обновление статуса на `suspended` или мягкое удаление
- Инвалидация всех сессий пользователя в этом тенанте

---

## 6. Мультиустройственная аутентификация (Multidevice)

### 6.1. Ключевые возможности

| Возможность | Описание |
|-------------|----------|
| **Множественные сессии** | Каждое устройство имеет независимую `family_id` |
| **Идентификация устройств** | Хранение информации об устройстве |
| **Управление устройствами** | Просмотр, переименование, удаление |
| **Ограничение количества** | Настраивается в `tenant.settings` |
| **Trusted devices** | Пометка доверенных устройств |
| **Push-уведомления** | Оповещение о событиях безопасности |
| **Принудительный выход** | Удаление конкретной сессии или всех |
| **История активности** | Отслеживание последней активности |

### 6.2. Политики управления устройствами

Настройки тенанта (JSONB):

```json
{
  "max_devices_per_user": 5,
  "allow_untrusted_devices": true,
  "require_mfa_for_untrusted": false,
  "session_inactivity_timeout_days": 30,
  "force_logout_after_password_change": true,
  "notify_on_new_device": true
}
```

### 6.3. Trusted Devices

**Критерии доверия**:
- Успешные входы с этого устройства в течение N дней
- Подтверждение через email/SMS
- Административная пометка

**Преимущества доверенных устройств**:
- Сниженные требования к MFA
- Более длительное время сессии
- Меньше проверок при敏感 операциях

---

## 7. API Контракты

### 7.1. Аутентификация

#### `POST /auth/login`

**Запрос**:
```json
{
  "identity": "user@example.com",
  "password": "secret",
  "device_name": "iPhone 15 Pro",
  "device_type": "mobile",
  "device_info": {
    "brand": "Apple",
    "model": "iPhone15,3",
    "os_version": "17.2"
  }
}
```

**Ответ 200 OK**:
```json
{
  "access_token": "eyJhbG...",
  "refresh_token": "opaque-token",
  "expires_in": 900,
  "token_type": "Bearer",
  "family_id": "uuid"
}
```

#### `POST /auth/refresh`

**Запрос**:
```json
{
  "refresh_token": "opaque-token"
}
```

**Ответ 200 OK**:
```json
{
  "access_token": "eyJhbG...",
  "refresh_token": "new-opaque-token",
  "expires_in": 900
}
```

#### `POST /auth/logout`

**Аутентификация**: Required

**Запрос**:
```json
{
  "refresh_token": "opaque-token" // опционально, если не указан — текущая сессия
}
```

**Ответ**: 204 No Content

#### `POST /auth/revoke-all`

**Аутентификация**: Required

**Ответ**: 204 No Content

### 7.2. Управление устройствами

#### `GET /auth/sessions`

**Ответ 200 OK**:
```json
{
  "sessions": [
    {
      "family_id": "uuid",
      "device_name": "iPhone 15 Pro",
      "device_type": "mobile",
      "last_active": "2024-01-15T10:30:00Z",
      "created_at": "2024-01-01T08:00:00Z",
      "ip_address": "192.168.1.100",
      "is_current": true,
      "is_trusted": true
    }
  ]
}
```

#### `DELETE /auth/sessions/{family_id}`

Завершение сессии на конкретном устройстве.

#### `PATCH /auth/sessions/{family_id}/trust`

Пометка устройства как доверенного.

#### `POST /auth/sessions/push-token`

Регистрация push-токена.

**Запрос**:
```json
{
  "push_token": "fcm-or-apns-token",
  "platform": "fcm",
  "app_version": "1.2.3"
}
```

### 7.3. Управление приглашениями

#### `POST /api/tenants/{tenant_id}/invites`

**Заголовки**: `Idempotency-Key: <uuid>` (обязательно)

**Запрос**:
```json
{
  "email": "user@example.com"
}
```

**Ответ 201 Created**:
```json
{
  "user_id": "uuid",
  "is_new": false,
  "invite_id": "uuid"
}
```

#### `POST /api/invites/accept`

**Аутентификация**: Required

**Запрос**:
```json
{
  "token": "opaque-token-from-email"
}
```

**Ответ 200 OK**:
```json
{
  "tenant_id": "uuid",
  "tenant_name": "Acme Corp",
  "status": "active"
}
```

#### `DELETE /api/tenants/{tenant_id}/members/{user_id}`

Исключение пользователя из тенанта (с инвалидацией сессий).

### 7.4. Восстановление пароля

#### `POST /auth/restore`

**Заголовки**: `Idempotency-Key: <uuid>` (обязательно)

**Запрос**:
```json
{
  "email": "user@example.com"
}
```

**Ответ**: 202 Accepted (всегда)

#### `POST /auth/reset-confirm`

**Заголовки**: `Idempotency-Key: <uuid>` (обязательно)

**Запрос**:
```json
{
  "token": "opaque-token",
  "new_password": "new-secret"
}
```

**Ответ 200 OK**:
```json
{
  "success": true
}
```

### 7.5. Публичные ключи

#### `GET /.well-known/jwks.json`

Возвращает JWKS (JSON Web Key Set) для проверки подписей JWT.

**Ответ 200 OK**:
```json
{
  "keys": [
    {
      "kid": "key-id-2024-01",
      "kty": "RSA",
      "alg": "RS256",
      "use": "sig",
      "n": "modulus-in-base64url",
      "e": "AQAB"
    }
  ]
}
```

### 7.6. Методы внутреннего использования (непубличные)

Эндпоинты для взаимодействия с другими сервисами, доступные только из внутренней сети:

#### `GET /internal/users/{user_id}/tenants`

Список тенантов пользователя с правами.

#### `POST /internal/verify-token`

Валидация JWT и получение информации о пользователе.

---

## 8. Спецификация JWT

### 8.1. Header

```json
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "key-id-2024-01"
}
```

### 8.2. Payload

```json
{
  "iss": "https://auth.example.com",
  "sub": "user-uuid",
  "tid": "tenant-uuid",
  "jti": "unique-token-id",
  "fam": "family-uuid",
  "iat": 1516239022,
  "exp": 1516239922
}
```

### 8.3. Описание полей

| Поле | Название | Описание |
|------|----------|----------|
| `iss` | Issuer | Идентификатор сервиса, выпустившего токен |
| `sub` | Subject | Идентификатор пользователя |
| `tid` | Tenant ID | Идентификатор тенанта |
| `jti` | JWT ID | Уникальный идентификатор токена |
| `fam` | Family ID | Идентификатор сессии/устройства |
| `iat` | Issued At | Время выпуска |
| `exp` | Expiration | Время истечения |

### 8.4. Время жизни токенов

| Токен | Время жизни | Примечание |
|-------|-------------|------------|
| Access Token | 15 минут | Короткое время для безопасности |
| Refresh Token | 30 дней | Обновляется при каждом использовании |
| Reset Token | 15 минут | Для сброса пароля |
| Invite Token | 7 дней | Для приглашений |

---

## 9. Инфраструктурные требования

### 9.1. Компоненты

| Компонент | Назначение | Требования к отказоустойчивости |
|-----------|------------|--------------------------------|
| **PostgreSQL** | Основное хранилище | Master + реплики, автоматический failover |
| **Redis** | Кэш, blacklist, rate limiting | Sentinel/Cluster, persistence опционально |
| **API Gateway** | Маршрутизация, rate limiting | Кластер, балансировка |
| **Auth Service** | Бизнес-логика | Горизонтальное масштабирование, stateless |

### 9.2. Graceful degradation

| Сценарий | Поведение |
|----------|-----------|
| Redis недоступен | Blacklist проверяется по in-memory кэшу, операции записи буферизируются |
| PostgreSQL replica недоступна | Read-операции перенаправляются на master |
| Email-сервис недоступен | Приглашения сохраняются, отправка в фоне при восстановлении |
| Push-сервис недоступен | Уведомления логируются, повтор при восстановлении |

### 9.3. Масштабирование

- **Горизонтальное масштабирование**: все экземпляры сервиса stateless
- **Сессии**: не хранятся в памяти, только в БД
- **Кэширование**: распределенный кэш (Redis) для blacklist
- **БД**: шардинг по tenant_id при необходимости

---

## 10. Нефункциональные требования

### 10.1. Инкапсуляция
- Сервис предоставляет эндпоинт `GET /.well-known/jwks.json` для раздачи публичных ключей
- Другие сервисы не имеют прямого доступа к БД AuthN
- Все взаимодействия через строго определенный API

### 10.2. Безопасность
- Все пароли хешируются Argon2id (настраиваемая сложность)
- Refresh-токены хранятся в виде SHA-256 хешей
- Токены сброса и приглашений — SHA-256 хеши
- Все критические операции в транзакциях
- Автоматическая ротация ключей подписи
- Graceful degradation при падении Redis

### 10.3. Идемпотентность
- Для мутационных эндпоинтов обязательна поддержка `Idempotency-Key`
- Хранение ключей с TTL для автоматической очистки
- Защита от дублирования операций

### 10.4. Мягкое удаление и GDPR
- Все таблицы с пользовательскими данными содержат `deleted_at`
- Уникальные индексы с учетом `deleted_at IS NULL`
- Batch-процесс анонимизации данных:
  - Пользователи со статусом `deleted` старше Retention Period
  - Замена персональных данных на плейсхолдеры
  - Сохранение связей для целостности

### 10.5. Мультитенантность
- Все запросы учитывают контекст тенанта
- Сессии привязаны к конкретному тенанту
- При исключении из тенанта — инвалидация всех сессий
- Изоляция данных на уровне БД

### 10.6. Rate Limiting

**Архитектурное решение**: Rate Limiting реализуется на уровне API Gateway.

**Обоснование**:
- Разделение ответственности
- Централизованное управление политиками
- Снятие нагрузки с сервиса
- Единая точка конфигурации

**Рекомендуемые лимиты для настройки на Gateway**:

| Эндпоинт | Лимит | Обоснование |
|----------|-------|-------------|
| `POST /auth/login` | 5/минута с IP | Защита от перебора |
| `POST /auth/restore` | 3/час с email | Защита от флуда |
| `POST /api/invites` | 10/минута от админа | Ограничение массовых приглашений |
| Публичные эндпоинты | 100/минута с IP | Базовая защита |

### 10.7. Обработка отказов (новая)

| Тип отказа | Действие |
|------------|----------|
| Ошибка БД (транзакционная) | Rollback, повтор операции (до 3 раз), затем ошибка |
| Ошибка сети (внешние сервисы) | Retry с exponential backoff |
| Redis timeout | Переключение на fallback, логирование |
| Перегрузка сервиса | Circuit breaker, возврат 503 |

---

## 11. Наблюдаемость

### 11.1. Логирование

**Структурированные логи в JSON формате**:

```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "info",
  "trace_id": "uuid",
  "service": "auth",
  "event": "user_login",
  "user_id": "uuid",
  "tenant_id": "uuid",
  "device_type": "mobile",
  "result": "success",
  "duration_ms": 45
}
```

**Обязательные поля**:
- `trace_id` — сквозная трассировка
- `user_id` — если аутентифицирован
- `tenant_id` — контекст тенанта
- `event` — тип события
- `duration_ms` — время выполнения

### 11.2. Метрики (Prometheus)

**Бизнес-метрики**:
- Активные сессии по тенантам
- Количество аутентификаций (успешные/неуспешные)
- Количество созданных инвайтов
- Количество активных устройств на пользователя

**Технические метрики**:
- RPS по эндпоинтам
- Время ответа (p50, p95, p99)
- Количество ошибок по типам (4xx, 5xx)
- Использование соединений к БД
- Время ответа Redis

**Метрики безопасности**:
- Обнаруженные атаки (reuse detection)
- Количество заблокированных сессий
- Попытки подбора паролей

### 11.3. Трассировка

- Сквозная трассировка с `trace_id` через все сервисы
- Заголовок `X-Request-ID` или `Traceparent` (W3C Trace Context)
- Сбор spans для критических операций:
  - Проверка пароля
  - Транзакции БД
  - Вызовы внешних сервисов

### 11.4. Health Checks

**Liveness Probe**: `/health/live`
- Проверяет, что сервис отвечает

**Readiness Probe**: `/health/ready`
- Проверяет соединение с БД и Redis
- Проверяет доступность критических зависимостей

---

## 12. Рекомендации по технологическому стеку  
*   **Web Framework**: **Axum** (отличная эргономика, интеграция с `tower`, `tracing`). 
*   **ORM/DB**: **SQLx** (compile-time проверка запросов, асинхронный, работа с миграциями). 
*   **Redis**: **redis-rs** (асинхронный клиент). 
*   **Валидация**: **Garde** или **validator**. 
*   **Типы**: **Uuid**, **chrono** (для дат). 
*   **Логирование/Трейсинг**: **tracing** (c `tracing-opentelemetry`, `tracing-appender`). 
*   **Метрики**: **metrics** (с экспортером в Prometheus). 
*   **Конфигурация**: **config**. 
*   **Криптография**:     *   Argon2id: **rust-argon2**.     
*   JWT: **jsonwebtoken** (поддержка RS256, kid).     
*   SHA-256: из стандартной библиотеки (`sha2` крейт). 
*   **Обработка ошибок**: **thiserror** (для библиотек/домена), **anyhow** (для приложения/бинарника).

## 13. Заключение

Данное техническое задание описывает полнофункциональный сервис аутентификации v.4.0 с улучшенной архитектурой:

| Аспект | Реализация |
|--------|------------|
| **Безопасность** | Token Rotation, Reuse Detection, Key Rotation, graceful degradation |
| **Мультитенантность** | M:M модель, строгая изоляция данных |
| **Инвайты** | Полная бизнес-логика с двумя сценариями |
| **Multidevice** | Управление устройствами, push-уведомления |
| **Идемпотентность** | Защита от дублирования операций |
| **GDPR** | Мягкое удаление, анонимизация |
| **Отказоустойчивость** | Graceful degradation при отказе компонентов |
| **Наблюдаемость** | Логи, метрики, трассировка |

Архитектура обеспечивает надежную, безопасную и масштабируемую основу для аутентификации в распределенной мультитенантной среде с учетом современных требований к отказоустойчивости и наблюдаемости.


